DEF[PORTVERSION]=	3.4.5
# ----------------------------------------------------------------------------

NAMEBASE=		opencv
VERSION=		${PORTVERSION}
KEYWORDS=		graphics
VARIANTS=		standard
SDESC[standard]=	Open Source Computer Vision library
HOMEPAGE=		https://opencv.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/opencv:opencv:${PORTVERSION}
DISTFILE[1]=		generated:main

SPKGS[standard]=	primary core

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

LICENSE=		BSD3CLAUSE:primary
LICENSE_FILE=		BSD3CLAUSE:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		graphics/opencv

BUILD_DEPENDS=		eigen:single:standard
			video4linux:headers:standard
BUILDRUN_DEPENDS=	jasper:primary:standard
			tiff:primary:standard
			WebP:single:standard
			video4linux:primary:standard
EXRUN[primary]=		opencv:core:standard

USES=			cmake pkgconfig jpeg png shebangfix zlib
SHEBANG_FILES=		cmake/templates/opencv_run_all_tests_unix.sh.in
			cmake/templates/setup_vars_linux.sh.in
			cmake/templates/setup_vars_macosx.sh.in
CMAKE_ARGS=		-DWITH_VTK:BOOL=OFF
			-DWITH_CUDA:BOOL=OFF
			-DWITH_CUFFT:BOOL=OFF
			-DWITH_CUBLAS:BOOL=OFF
			-DWITH_NVCUVID:BOOL=OFF
			-DWITH_GSTREAMER_0_10:BOOL=OFF
			-DWITH_GTK:BOOL=OFF
			-DWITH_IPP:BOOL=OFF
			-DWITH_PVAPI:BOOL=OFF
			-DWITH_GIGEAPI:BOOL=OFF
			-DWITH_QUICKTIME:BOOL=OFF
			-DWITH_OPENCL_SVM:BOOL=OFF
			-DWITH_INTELPERC:BOOL=OFF
			-DWITH_IPP_A:BOOL=OFF
			-DWITH_MATLAB:BOOL=OFF
			-DWITH_VA:BOOL=OFF
			-DWITH_VA_INTEL:BOOL=OFF
			-DWITH_LAPACK:BOOL=OFF
			-DWITH_EIGEN:BOOL=ON
			-DWITH_JASPER:BOOL=ON
			-DWITH_JPEG:BOOL=ON
			-DWITH_PNG:BOOL=ON
			-DWITH_TIFF:BOOL=ON
			-DWITH_WEBP:BOOL=ON
			-DWITH_V4L:BOOL=ON
			-DWITH-LIB4VL:BOOL=ON
			-DBUILD_SHARED_LIBS:BOOL=ON
			-DBUILD_ANDROID_EXAMPLES:BOOL=OFF
			-DBUILD_DOCS:BOOL=OFF
			-DBUILD_PACKAGE:BOOL=OFF
			-DBUILD_PERF_TESTS:BOOL=OFF
			-DBUILD_TESTS:BOOL=OFF
			-DBUILD_WITH_DEBUG_INFO:BOOL=OFF
			-DBUILD_WITH_STATIC_CRT:BOOL=OFF
			-DBUILD_WITH_DYNAMIC_IPP:BOOL=OFF
			-DBUILD_FAT_JAVA_LIB:BOOL=OFF
			-DBUILD_ANDROID_SERVICE:BOOL=OFF
			-DBUILD_CUDA_STUBS:BOOL=OFF
			-DBUILD_ZLIB:BOOL=OFF
			-DBUILD_TIFF:BOOL=OFF
			-DBUILD_JASPER:BOOL=OFF
			-DBUILD_JPEG:BOOL=OFF
			-DBUILD_PNG:BOOL=OFF
			-DBUILD_OPENEXR:BOOL=OFF
			-DBUILD_TBB:BOOL=OFF
			-DBUILD_PROTOBUF:BOOL=OFF
			-DBUILD_EXAMPLES:BOOL=OFF
			-DENABLE_OMIT_FRAME_POINTER:BOOL=ON
			-DENABLE_FAST_MATH:BOOL=OFF
			-DENABLE_PRECOMPILED_HEADERS:BOOL=OFF
			-DEOPENCV_WARNINGS_ARE_ERRORS:BOOL=OFF
			-DANDROID_EXAMPLES_WITH_LIBS:BOOL=ON
			-DDOWNLOAD_EXTERNAL_TEST_DATA:BOOL=OFF
			-DBUILD_opencv_apps:BOOL=ON
			-DBUILD_opencv_cnn_3dobj:BOOL=OFF
			-DBUILD_opencv_ts:BOOL=OFF
			-DBUILD_opencv_world:BOOL=OFF
			-DBUILD_opencv_java:BOOL=OFF
			-DBUILD_opencv_python2:BOOL=OFF
			-DBUILD_opencv_python3:BOOL=OFF
# |			-DPYTHON_EXECUTABLE:FILEPATH="{{PYTHON_CMD}}"

SUB_FILES=		FindOpenCVCore.cmake
SUB_LIST=		OCV_VERSION=${PORTVERSION}
PLIST_SUB=		SOXDOTY=${PORTVERSION:R}
SOVERSION=		${PORTVERSION}

# skip FP16,POPCNT,FMA3 on x86_64 to widen common denominator
VAR_ARCH[x86_64]=	CMAKE_ARGS=-DCPU_BASELINE_DISABLE:STRING="FP16,POPCNT,FMA3"

post-patch:
	${REINPLACE_CMD} -e 's|share/OpenCV/doc|${DOCSDIR_REL}|g' \
		-e 's|share/OpenCV/samples|${EXAMPLESDIR_REL}|g' \
		${WRKSRC}/CMakeLists.txt
	${FIND} ${WRKSRC} -name '*.orig' -delete
	${REINPLACE_CMD} -e 's|__PREFIX__|${PREFIX}|' \
		${WRKSRC}/cmake/templates/opencv_run_all_tests_unix.sh.in \
		${WRKSRC}/cmake/templates/setup_vars_linux.sh.in \
		${WRKSRC}/cmake/templates/setup_vars_macosx.sh.in \

post-install:
	${SED} -e 's|Name:.*|Name: OpenCV-core|' \
		${STAGEDIR}${PREFIX}/lib/pkgconfig/opencv.pc \
		> ${STAGEDIR}${PREFIX}/lib/pkgconfig/opencv-core.pc
	${MKDIR} ${STAGEDIR}${PREFIX}/share/cmake/Modules
	${INSTALL_DATA} ${WRKDIR}/FindOpenCVCore.cmake \
		${STAGEDIR}${PREFIX}/share/cmake/Modules
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/lib/*.so
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/bin/opencv_*
