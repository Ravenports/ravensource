# May need to lock version if following warning breaks rpath setting:
# src/meson.build:72: WARNING: Passed invalid keyword argument "install_rpath"
# Update restricted to John Marino.
# Reason: meson breaks on sunos just about every update (mispatch) so
# it needs to be checked on each platform first.
#
# DELETE std variant after new meson handling fully adopted (every platform published new packages)
# DELETE NONSTD option at the same time
# std variant and v13 variant should be identical
#
DEF[PORTVERSION]=	1.10.0
DEF[WHLHASH]=		32/4f/c398c6f06ece1c6c246e008d5dac3824c98f54d3eb3d8014f4910afd6d48
# ----------------------------------------------------------------------------

NAMEBASE=		meson
VERSION=		${PORTVERSION}
KEYWORDS=		devel python
VARIANTS=		std v13 v14
SDESC[std]=		High performance build system
SDESC[v13]=		High performance build system (py 3.13)
SDESC[v14]=		High performance build system (py 3.14)
HOMEPAGE=		https://mesonbuild.com
CONTACT=		John_Marino[draco@marino.st]

DOWNLOAD_GROUPS=	main
SITES[main]=		PYPIWHL/${WHLHASH}
DISTFILE[1]=		meson-${PORTVERSION}-py3-none-any.whl:main
DIST_SUBDIR=		python-src

SPKGS[std]=		single
SPKGS[v13]=		single
SPKGS[v14]=		single

OPTIONS_AVAILABLE=	PY313 PY314
OPTIONS_STANDARD=	none
VOPTS[v13]=		PY313=ON PY314=OFF
VOPTS[v14]=		PY313=OFF PY314=ON

LICENSE=		APACHE20:single
LICENSE_FILE=		APACHE20:stock
LICENSE_TERMS=		single:{{WRKDIR}}/TERMS
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		devel/meson

PATCH_WRKSRC=		{{WRKSRC}}/{{PYTHON_SITELIBDIR}}

[PY314].USES_ON=			python:v14,wheel
[PY314].RUN_DEPENDS_ON=			python-ninja:single:v13
[PY314].USES_OFF=			python:v13,wheel
[PY314].RUN_DEPENDS_OFF=		python-ninja:single:v13

post-extract:
	${MKDIR} ${WRKSRC}
	${SETENV} AUTOPYTHON=${_PYTHON_VERSION} \
	pip install --verbose \
		--no-deps \
		--no-index \
		--no-compile \
		--progress-bar off \
		--root ${WRKSRC} \
		${DISTDIR}/${DIST_SUBDIR}/${DISTFILE_1:C/:.*//}
	# extract license terms
	${AWK} '/^from / {exit}; {print}' ${PATCH_WRKSRC}/mesonbuild/mesonmain.py > ${WRKDIR}/TERMS

pre-configure:
	${FIND} ${WRKSRC} -name "*.orig" -type f -delete

do-install:
	${MKDIR} ${STAGEDIR}
	${MV} ${WRKSRC}${PREFIX} ${STAGEDIR}/
	(cd ${STAGEDIR} && ${PYTHON_CMD} -m compileall -d / . ||:)
