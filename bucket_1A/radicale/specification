# manually maintained due to server support
# The users won't be able to install version from both pythons due to
# common files and directories
DEF[PORTVERSION]=	3.6.1
DEF[TAG]=		v${PORTVERSION}
# ------------------------------------------------------------------------

NAMEBASE=		radicale
VERSION=		${PORTVERSION}
KEYWORDS=		python
VARIANTS=		std
SDESC[std]=		CalDAV and CardDAV Server
HOMEPAGE=		https://radicale.org/
CONTACT=		Python_Automaton[python@ironwolf.systems]

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/Kozea:Radicale:${TAG}
DISTFILE[1]=		generated:main
# SITES[main]=		PYPIWHL/0f/6c/38ff9bad1e60d0311d0564d20d7b6d802e89bc5075289cec456d73feae8e
# DISTFILE[1]=		radicale-${PORTVERSION}-py3-none-any.whl:main

SPKGS[std]=		single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

LICENSE=		GPLv3+:single
LICENSE_FILE=		GPLv3+:{{WRKSRC}}/COPYING.md
LICENSE_TERMS=		single:{{WRKDIR}}/TERMS
LICENSE_AWK=		TERMS:"Radicale WSGI application"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/radicale/app/__init__.py
LICENSE_SCHEME=		solo

# Requires-Dist extracted from wheel metadata
# defusedxml
# libpass>=1.9.3
# vobject>=0.9.6
# pika>=1.1.0
# requests
# packaging
# pytest>=7; extra == "test"
# waitress; extra == "test"
# bcrypt; extra == "test"
# argon2-cffi; extra == "test"
# bcrypt; extra == "bcrypt"
# argon2-cffi; extra == "argon2"
# ldap3; extra == "ldap"
# pytest; extra == "integ-test"
# pytest-playwright; extra == "integ-test"

DISTNAME=		Radicale-${PORTVERSION}
GENERATED=		yes

USERS=			radicale
GROUPS=			radicale
USERGROUP_SPKG=		single

BUILDRUN_DEPENDS=	python-defusedxml:single:python_used
			python-libpass:single:python_used
			python-vobject:single:python_used
			python-pika:single:python_used
			python-requests:single:python_used
			python-packaging:single:python_used

RC_SUBR=		radicale:single
SUB_FILES=		manifest.xml
SUB_LIST=		RAD_USR={{USERS}}
			RAD_GRP={{GROUPS}}
			PYTHON_CMD="{{PYTHON_CMD}}"

USES=			cpe shebangfix python:pep517
			smf:single
SHEBANG_FILES=		radicale.wsgi

post-extract:
	${MV} ${WRKSRC}/setup.py.legacy ${WRKSRC}/setup.py

pre-configure:
	${REINPLACE_CMD} \
		-e 's,/etc/radicale,${PREFIX}/etc/radicale,g' \
		-e 's,/etc/ssl,${PREFIX}/etc/radicale,g' \
		-e 's,/var/lib/radicale,${PREFIX}/share/radicale,g' \
		${WRKSRC}/config \
		${WRKSRC}/radicale/config.py

post-install:
	${MKDIR} ${STAGEDIR}/${PREFIX}/etc/radicale
	${MKDIR} ${STAGEDIR}/${PREFIX}/share/radicale
	${MKDIR} ${STAGEDIR}/${PREFIX}/www/radicale
	${INSTALL_DATA} ${WRKSRC}/config \
		${STAGEDIR}/${PREFIX}/etc/radicale/config.sample
	${INSTALL_DATA} ${WRKSRC}/rights \
		${STAGEDIR}/${PREFIX}/etc/radicale/rights.sample
	${INSTALL_SCRIPT} ${WRKSRC}/radicale.wsgi \
		${STAGEDIR}${PREFIX}/www/radicale/radicale.wsgi
