DEF[PORTVERSION]=	5.77
# ----------------------------------------------------------------------------

NAMEBASE=		stunnel
VERSION=		${PORTVERSION}
REVISION=		1
KEYWORDS=		security
VARIANTS=		std
SDESC[std]=		SSL/TLS offloading and load-balancing proxy
HOMEPAGE=		https://www.stunnel.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://www.stunnel.org/downloads/archive/5.x/
DISTFILE[1]=		stunnel-${PORTVERSION}.tar.gz:main

SPKGS[std]=		set primary dev docs examples man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

FPC_EQUIVALENT=		security/stunnel

LICENSE=		GPLv2+:primary
LICENSE_FILE=		GPLv2+:stock
LICENSE_TERMS=		primary:{{WRKSRC}}/COPYING.md
LICENSE_SCHEME=		solo

RC_SUBR=		stunnel:primary

USERS=			stunnel
GROUPS=			stunnel
USERGROUP_SPKG=		primary

USES=			cpe libtool perl:build shebangfix ssl:openssl30
SHEBANG_FILES=		src/stunnel3.in
MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--localstatedir={{PREFIX}}/var
			--enable-static
			--disable-systemd
			--with-ssl="{{OPENSSLBASE}}"
			--with-threads=pthread
			--enable-fips
			--enable-ipv6
LDFLAGS=		-lpthread
INSTALL_TARGET=		install-strip
SUB_LIST=		STUNNEL_USER={{USERS}}
			STUNNEL_GROUP={{GROUPS}}
			STUNNEL_PIDFILE={{PREFIX}}/var/run/stunnel/stunnel.pid
PLIST_SUB=		OWN={{USERS}}
			GRP={{GROUPS}}

pre-configure:
	${REINPLACE_CMD} -e '\
	    s|@DEFAULT_GROUP@|${GROUPS}|g; \
	    s|install-confDATA install-data-local|install-confDATA|g; \
	    s|stunnel.logrotate||g; \
	    s|stunnel.rh.init||g' \
	    ${WRKSRC}/tools/Makefile.in

	# don't add stack-protector
	${REINPLACE_CMD} -e 's|-fstack-protector||' ${WRKSRC}/configure
	# relocate examples
	${REINPLACE_CMD} -E -e 's|\$$\(docdir\)/examples|${STD_EXAMPLESDIR}|g' \
		${WRKSRC}/tools/Makefile.in

post-install:
	${MKDIR} ${STAGEDIR}${PREFIX}/var/log/stunnel
	${MKDIR} ${STAGEDIR}${PREFIX}/var/run/stunnel
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/stunnel/conf.d/
	${INSTALL_DATA} ${FILESDIR}/pid.conf \
		${STAGEDIR}${PREFIX}/etc/stunnel/conf.d/00-pid.conf
	${RM} ${STAGEDIR}${STD_DOCDIR}/COPYING.md
	${RM} ${STAGEDIR}${STD_DOCDIR}/COPYRIGHT.md