DEF[PORTVERSION]=	15.0.2
DEF[CBSD_HOME]=		/cbsd
# ----------------------------------------------------------------------------

NAMEBASE=		cbsd
VERSION=		${PORTVERSION}
KEYWORDS=		sysutils
VARIANTS=		std
SDESC[std]=		FreeBSD jails, bhyve and Xen manager
HOMEPAGE=		https://www.bsdstore.ru/en/about.html
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/cbsd:cbsd:v${PORTVERSION}
DISTFILE[1]=		generated:main

SPKGS[std]=		set primary man docs examples

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

FPC_EQUIVALENT=		sysutils/cbsd

LICENSE=		BSD2CLAUSE:primary
LICENSE_FILE=		BSD2CLAUSE:{{WRKDIR}}/LICENSE
LICENSE_SCHEME=		solo

ONLY_FOR_OPSYS=		freebsd dragonfly midnightbsd

RUN_DEPENDS=		rsync:set:std
			sudo:set:std
BUILD_DEPENDS=		elftoolchain:dev:std
			libssh2:dev:std
			curl:dev:std
			file:dev:std
			libedit:dev:std
			coreutils:primary:noprefix
BUILDRUN_DEPENDS=	libssh2:primary:std
			libedit:primary:std
			file:primary:std
			curl:primary:std

RC_SUBR=		cbsdd:primary
			cbsdrsyncd:primary
			cbsd-statsd-bhyve:primary
			cbsd-statsd-hoster:primary
			cbsd-statsd-jail:primary

SUB_FILES=		messages-primary.ucl

USERS=			cbsd
GROUPS=			cbsd
USERGROUP_SPKG=		primary

USES=			autoreconf:build pkgconfig:buildrun gmake ssl sqlite
MAKE_ARGS=		STRIP={{STRIP_CMD}}
MANDIRS=		{{PREFIX}}/cbsd/man
SINGLE_JOB=		yes

VAR_OPSYS[freebsd]=	LDFLAGS=-ljail

pre-configure:
	# rename conflicting function
	${REINPLACE_CMD} -e "s|sigblockall|mysigblockall|g" \
		${WRKSRC}/bin/cbsdsh/src/jobs.[ch] \
		${WRKSRC}/bin/cbsdsh/src/trap.[ch]

	# remove system elf header
	${REINPLACE_CMD} -e '/<sys\/elf_common.h>/d' \
		${WRKSRC}/misc/src/elf_tables.c
	# fix hardcoded paths
	${GREP} -rl '/usr/local' ${WRKSRC} | ${XARGS} \
		${SED} -i'' -e 's|/usr/local|${PREFIX}|g'

	# relocate license
	${MV} ${WRKSRC}/LICENSE ${WRKDIR}/

	# autoreconf
	(cd ${WRKSRC}/bin/cbsdsh && autoreconf -iv)

pre-install:
	# get rid of stuff we don't want installed
	${FIND} ${WRKSRC} -type f -name .gitignore -delete
	${FIND} ${WRKSRC} -type f -name "*.orig" -delete
	${FIND} ${WRKSRC} -type f -name "*.bak" -delete
	${FIND} ${WRKSRC} -type f -name placeholder -delete
	${RM} ${WRKSRC}/Makefile
	${RM} ${WRKSRC}/.clang-format

do-install:
	@${ECHO_MSG} "Installing in ${PREFIX}${CBSD_HOME}"
	${CP} -a ${WRKSRC} ${STAGEDIR}${PREFIX}${CBSD_HOME}
	${INSTALL_PROGRAM} ${WRKSRC}/bin/cbsdsh/cbsd \
		${STAGEDIR}${PREFIX}/bin
	${INSTALL_PROGRAM} ${WRKSRC}/misc/src/sipcalc/sipcalc \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/misc
	${INSTALL_PROGRAM} ${WRKSRC}/misc/src/cbsd_md5/cbsd_md5 \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/misc
	${RM} -r ${STAGEDIR}${PREFIX}${CBSD_HOME}/bin/cbsdsh \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/bin/src \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/lib \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/misc/src \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/sbin/src \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/tools/src
	${INSTALL_MAN} ${WRKSRC}/man/cbsd.8 \
		${STAGEDIR}${PREFIX}/share/man/man8
	${MKDIR} ${STAGEDIR}${PREFIX}/libexec/bsdconfig
	(cd ${STAGEDIR}${PREFIX}/libexec/bsdconfig &&\
		${LN} -sf ../..${CBSD_HOME}/share/bsdconfig/cbsd cbsd)

	# define samples
	${MV} ${STAGEDIR}${PREFIX}${CBSD_HOME}/etc/modules.conf \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/etc/modules.conf.sample
	${MV} ${STAGEDIR}${PREFIX}${CBSD_HOME}/etc/spice.conf \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/etc/spice.conf.sample
	${MV} ${STAGEDIR}${PREFIX}${CBSD_HOME}/cbsd.conf \
		${STAGEDIR}${PREFIX}${CBSD_HOME}/cbsd.conf.sample

	# move examples to standard location
	${MKDIR} ${STAGEDIR}${STD_EXAMPLESDIR}
	${MV} ${STAGEDIR}${PREFIX}${CBSD_HOME}/share/examples/* ${STAGEDIR}${STD_EXAMPLESDIR}/
	${RMDIR} ${STAGEDIR}${PREFIX}${CBSD_HOME}/share/examples

	# move documents to standard location
	${MKDIR} ${STAGEDIR}${STD_DOCDIR}
	${MV} ${STAGEDIR}${PREFIX}${CBSD_HOME}/share/docs/* ${STAGEDIR}${STD_DOCDIR}/
	${MV} ${STAGEDIR}${PREFIX}${CBSD_HOME}/*.md ${STAGEDIR}${STD_DOCDIR}/
	${FIND} ${STAGEDIR}${PREFIX}${CBSD_HOME}/share/docs -empty -delete
