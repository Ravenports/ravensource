DEF[PORTVERSION]=	4.0.0
DEF[FRAMEWORK_TAG]=	f58263d
DEF[TPCRYPTO_TAG]=	cb9d0ed
DEF[SUBFRAME_TAG]=	1726775
DEF[SO_TLS]=		22
DEF[SO_509]=		8
DEF[SO_CRYPTO]=		17
DEF[SO_TFPSA]=		1.0.0
DEF[SOVERSION]=		4.0.0
# ----------------------------------------------------------------------------

NAMEBASE=		mbedtls
VERSION=		${PORTVERSION}
KEYWORDS=		security devel
VARIANTS=		std
SDESC[std]=		Light-weight cryptographic and SSL/TLS library
HOMEPAGE=		https://www.trustedfirmware.org/projects/mbed-tls/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main framework crypto subframe
SITES[main]=		GITHUB/ARMmbed:mbedtls:v${PORTVERSION}
SITES[framework]=	GITHUB/Mbed-TLS:mbedtls-framework:${FRAMEWORK_TAG}:framework
SITES[crypto]=		GITHUB/Mbed-TLS:TF-PSA-Crypto:${TPCRYPTO_TAG}:tf-psa-crypto
SITES[subframe]=	GITHUB/Mbed-TLS:mbedtls-framework:${SUBFRAME_TAG}:tf-psa-crypto/framework
DISTFILE[1]=		generated:main
DISTFILE[2]=		generated:framework
DISTFILE[3]=		generated:crypto
DISTFILE[4]=		generated:subframe
DF_INDEX=		1 2 3 4

SPKGS[std]=		set primary tools dev

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

FPC_EQUIVALENT=		security/mbedtls3

LICENSE=		APACHE20:primary GPLv2+:primary
LICENSE_FILE=		APACHE20:stock
			GPLv2+:stock
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_AWK=		TERMS:"^The full text of each"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		dual

BUILD_DEPENDS=		python-Jinja2:single:python_used
			python-jsonschema:single:python_used

EXRUN[tools]=		mbedtls:primary:std

USES=			cpe cmake perl:build python:build
CPE_VENDOR=		arm
CPE_PRODUCT=		mbed_tls
CMAKE_ARGS=		-DENABLE_TESTING:BOOL=OFF
			-DUSE_SHARED_MBEDTLS_LIBRARY:BOOL=ON
PLIST_SUB=		SO_TLS=${SO_TLS}
			SO_509=${SO_509}
			SO_CRYPTO=${SO_CRYPTO}
			SO_TFPSA=${SO_TFPSA}
			SO_TFPSAMAJ=${SO_TFPSA:R:R}
SOVERSION=		${SOVERSION}

VAR_OPSYS[sunos]=	LDFLAGS=-lsocket

post-install:
	# correct obvious bug in CMakeList.txt wrt DESTDIR
	${MV} ${PREFIX}/lib/libmbedcrypto.so ${STAGEDIR}${PREFIX}/lib/
	${MV} ${PREFIX}/lib/libmbedcrypto.so.${SO_CRYPTO} ${STAGEDIR}${PREFIX}/lib/

	${STRIP_CMD} ${STAGEDIR}${PREFIX}/lib/lib*.so
	${FIND} ${STAGEDIR}${PREFIX}/bin -type f | while read f; \
	do \
	  check=$$(file "$$f" | grep "dynamically linked"); \
	  if [ -n "$$check" ]; then \
	    ${STRIP_CMD} "$$f"; \
	  fi; \
	done
