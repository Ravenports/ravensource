From dbacb9b5545315e7045ef082dba99d2c96ed1356 Mon Sep 17 00:00:00 2001
From: Pierre-Marie de Rodat <derodat@adacore.com>
Date: Tue, 3 Dec 2024 11:42:00 +0000
Subject: [PATCH] Transition uses of the Python pipes module to shlex

"pipes" was removed from Python 3.13.
---
 langkit/compiled_types.py | 4 ++--
 langkit/libmanage.py      | 6 ++----
 langkit/utils/__init__.py | 3 +--
 3 files changed, 5 insertions(+), 8 deletions(-)

--- langkit/compiled_types.py.orig	2024-09-17 09:18:15 UTC
+++ langkit/compiled_types.py
@@ -6,7 +6,7 @@ from contextlib import AbstractContextMa
 from dataclasses import dataclass
 import difflib
 from itertools import count, takewhile
-import pipes
+import shlex
 from typing import (
     Any, Callable, ClassVar, Dict, Iterator, List, Optional as Opt, Sequence,
     Set, TYPE_CHECKING, Tuple, Union, ValuesView
@@ -52,7 +52,7 @@ def gdb_helper(*args):
     :param list[str] args: Elements of the special comment.
     :rtype: str
     """
-    return ('--# {}'.format(' '.join(pipes.quote(a) for a in args))
+    return ('--# {}'.format(shlex.join(args))
             if get_context().emitter.generate_gdb_hook else '')
 
 
--- langkit/libmanage.py.orig	2024-09-17 09:18:15 UTC
+++ langkit/libmanage.py
@@ -9,7 +9,7 @@ import json
 import os
 from os import path
 import pdb
-import pipes
+import shlex
 import shutil
 import subprocess
 import sys
@@ -1581,9 +1581,7 @@ class ManageScript(abc.ABC):
         :param argv: Arguments for the command to log.
         """
         if self.verbosity.debug:
-            printcol('Executing: {}'.format(
-                ' '.join(pipes.quote(arg) for arg in argv)
-            ), Colors.CYAN)
+            printcol('Executing: {}'.format(shlex.join(argv)), Colors.CYAN)
 
     def log_info(self, msg: str, color: str) -> None:
         """
--- langkit/utils/__init__.py.orig	2024-09-17 09:18:15 UTC
+++ langkit/utils/__init__.py
@@ -11,7 +11,6 @@ from contextlib import ExitStack, contex
 from copy import copy
 from enum import Enum
 import os
-import pipes
 import shlex
 import shutil
 from typing import (
@@ -265,7 +264,7 @@ def format_setenv(name: str, path: str)
     environment variable.
     """
     return (
-        f'{name}={pipes.quote(path)}"{os.pathsep}${name}";'
+        f'{name}={shlex.quote(path)}"{os.pathsep}${name}";'
         f" export {name}"
     )
 
